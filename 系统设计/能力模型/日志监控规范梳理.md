### 异常

1. 不要用异常来做流程控制，能用预检查避免的尽量用预检查。比如NPE、数组越界等
2. 不要直接catch一大段代码，要区分稳定代码合非稳定代码，只对非稳定代码做catch。同时最好catch具体的异常类，不推荐直接catch Exception或者Thrownble。
3. 不要吞掉异常，catch异常就是为了处理他，如果处理不了就向上抛出。这里的吞掉异常包括两种情况：一种catch后啥都不做，一种是catch后抛出另一个异常。不要过多的进行异常转义，除非在服务最上层或者系统之间/分层之间的调用。即使转义也要包住最初的异常。//todo: catch异常如何返回
4. 推荐统一异常处理，理论上正常逻辑代码和异常逻辑代码应该隔离，开发时只需要聚焦于业务逻辑，出现异常直接抛出即可，只在最上层进行异常转义，转化为用户可以理解的内容--- 除了那些不影响业务主流程的非核心流程，即你可以处理的，不影响主流程正常流转的异常。// todo:分级加一下典型例子
5. 尽量不要对事务进行try-catch，如果有，记得回滚。
6. 对资源、流进行try时记得使用finally关闭，推荐使用try-with-resources；在finally中注意不要使用return，因为finally会在try的return之前执行，如果其中使用了return，则try中的return不会执行。
7. 数据库和rpc返回的对象要进行空值判断；rpc之间的调用推荐使用状态码，不要直接抛出异常。

### 日志

1. 应用中不可直接使用日志系统（Log4j、Logback）中的 API，而应依赖使用日志框架 SLF4J 中的 API，使用门面模式的日志框架，有利于维护和各个类的日志处理方式统一。
2. 日志文件推荐至少保存 15 天，因为有些异常具备以“周”为频次发生的特点。
3. 日志输出推荐使用占位符的方式，尽量避免字符串拼接。因为即使这个日志没有输出，字符串拼接操作还是会执行，如果包含对象，还会调用tostring方法，浪费性能。（当然如果确定该日志必定会输出，可以使用字符串拼接，因为Slf4j的占位符其实就是占位符的查找和字符串拼接，比起直接的字符串拼接，性能可能还会差点。其实这点性能损耗意义不大，除非是那些对性能特别敏感的系统，不要盲目追求性能）
4. 避免重复打印日志，浪费磁盘空间，务必在 log4j.xml 中设置 additivity=false
5. 异常信息应当全面，需要包含案发现场信息（即上下文信息）与异常堆栈信息。不要打一些对排查问题毫无意义的异常信息。毫无用处不说，还浪费性能和磁盘资源。  //todo: 占位符注意要和参数对其
6. 打印日志同时也需要谨慎，因为打印日志是需要耗费性能和磁盘资源的（高QPS的接口尤其要谨慎）。你需要在排查问题与接口性能和磁盘资源之间做好权衡。记录日志时请思考：这些日志真的有人看吗？看到这条日志你能做什么？能不能给问题排查带来好处？
   - 避免在高QPS的接口或者循环中打印日志
   - 避免直接打印大对象日志，即直接序列化整个大对象，而应当只打印关键信息   //尽量加个条件判断
   - 不要直接打印整个list对象
   - 如果实在避免不了要打的话，请将日志目录放在/home/xiaoju/data1下面，这个文件夹挂载在其他的磁盘下面，避免打爆根盘，而且这个盘比根盘大很多（仅对滴滴）
7. 日志级别要权衡好，不要随便打印error日志，导致无意义的报警。理论上每一条error日志都需要处理，对于那些无法处理或者不影响主流程的error日志可以进行降级，比如参数校验、不影响业务主流程的RPC调用失败等。

### 监控/报警

1. 系统监控：cpu监控、内存监控、磁盘监控、线程池监控等
2. JVM监控：新生代监控、老年代监控、元数据区（方法区）监 控、fullGC监控等
3. 核心接口与业务流程：QPS、RT、ERROR监控
4. 业务指标监控：
   - 数量监控：比如分场景对业务单据和账单的数量进行监控，这样可以通过业务单据和账单的数量对比就可以看出各场景计费清分是否有问题。
   - 金额监控：可以直观看到各场景、商、仓每天的结算金额，及其走势。根据平均走势就可以设置金额阈值报警，发现每天异常金额
5. 慢SQL监控与告警 -- todo

## 定时任务

1. 定时任务异常报警：目前有些任务没有执行失败报警，无法感知到任务的执行成功与否
2. 定时任务失败补偿：需要个定时任务失败表，对执行失败的定时任务进行批量补偿
3. 统计和治理定时任务的执行时间：避免任务同时执行导致系统负载过高；同时错开每天的发布时间，避免由于发布导致任务执行失败
4. 账单未产出报警：清算系统可以通过账期定时检查各场景再账期内是否未产出账单
5. 数据对账：需要个对账系统，比对上下游数据的准确性
6. todo：统一定时任务组件，找一个公司主流、维护最好的能找到人的组件