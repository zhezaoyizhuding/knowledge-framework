## hashMap过大问题

### 现象

cpu飙升，内存占用也挺高

### 排查步骤

1、登录上线机器，top/ps命令定位出java进程中cpu占用最高的线程，发现多个线程cpu占用都挺高

2、jstack转义出线程堆栈，发现在一个hashmap的hashcode方法处结束了

3、考虑到cpu过高的原因一般是大量线程空转，不释放cpu时间片。而这一般有两种可能，一种是死循环，比如递归出错；一种是循环次数太多，比如for循环的临界值太大。

4、重点排查这处hashmap的使用代码，发现这个hashMap是本地方法中new出来的，没有并发问题。但是hashmap太大，每次都是捞出表里的全量数据，塞入hashMap，循环put。同时又没有预估hashMap的大小，导致hashmap频繁扩容，每次扩容又会循环put。这就造成cpu飙升，并且内存占用也挺高的问题

### 解决办法

1、预估hashmap容量，避免频繁扩容，同时使用ConcurrentHashMap代替，将改数据替换为线程共用的，避免每个线程都会重复创建

2、借用数据库的能力，不要放在应用代码中

## 账单导出，分批不当，导致OOM

分批数设置不合理。开发同学以为一行数据很小，就设置了每批10000万条，但是其中有个扩展字段很大，导致了OOM



## 堆外内存使用不恰当，导致OOM问题







