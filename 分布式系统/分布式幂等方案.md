## 定义

维基百科中定义如下：

> 在[数学](https://zh.wikipedia.org/wiki/數學)里，**幂等**有两种主要的定义。
>
> - 在某[二元运算](https://zh.wikipedia.org/wiki/二元運算)下，**幂等元素**是指被自己重复运算（或对于[函数](https://zh.wikipedia.org/wiki/函數)是为[复合](https://zh.wikipedia.org/wiki/复合函数)）的结果等于它自己的元素。例如，乘法下唯一两个幂等[实数](https://zh.wikipedia.org/wiki/實數)为0和1。
> - 某[一元运算](https://zh.wikipedia.org/wiki/一元運算)为**幂等**的时，其作用在任一元素两次后会和其作用一次的结果相同。例如，[高斯符号](https://zh.wikipedia.org/wiki/高斯符號)便是幂等的。

引申到程序中就可以定义为：

对于同一个函数或者程序段，相同的入参在进入1次或者N次，该函数或者程序段产生的结果都是相同的，没有副作用的。

## 解决方案

对于幂等的解决方案大致相同，都是对于一个分布式唯一标识做去重处理。但是由于存储介质的不同，也有不同的实现方案。

#### 全局ID/token 机制 + 分布式锁

其实就是通用的分布式锁，使用redis或者zookeeper来存储唯一标识。zk的稳定性更高，但是实现方式更复杂一些，大多数公司的架构都是采用redis来简单处理。但是由于redis并没有持久化处理，所以稳定性不高，并不能完全信任redis实现的幂等机制。

适用于日志这种对幂等性要求不高的业务，如果涉及订单或者金额，可采用下面的mysql方案。

#### mysql唯一约束

对于mysql唯一约束，由于业务的不同又分为去重表和状态机

##### 去重表/消费记录表

根据mysql的唯一索引来实现

##### 状态机

根据唯一索引和状态值。其实就是一种乐观锁的实现机制。该种方式性能最好。



